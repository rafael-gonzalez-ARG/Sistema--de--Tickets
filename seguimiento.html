<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Seguimiento de Tickets | SoporteTech</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="seguimiento.css" />
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo">ğŸ› ï¸ SoporteTech</div>
            <nav>
                <ul class="nav">
                    <li><a href="index.html#inicio">Inicio</a></li>
                    <li><a href="index.html#servicios">Servicios</a></li>
                    <li><a href="index.html#crear-ticket">Crear Ticket</a></li>
                    <li><a href="index.html#mis-tickets">Mis Tickets</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="tracking-section">
        <div class="container">
            <h2 class="section-title" id="pageTitle">ğŸ“‹ Seguimiento de Mis Tickets</h2>
            <p class="intro-text" id="introText">
                AquÃ­ puedes ver el estado de todos los tickets que has enviado. Usa la funcionalidad de comentarios para aÃ±adir mÃ¡s detalles.
            </p>

            <div class="email-filter-box" id="emailFilterBox">
                <label for="filterEmail">Mostrar tickets para el correo:</label>
                <input type="email" id="filterEmail" placeholder="Ingresa tu correo para filtrar" class="email-input">
                <button onclick="filterTicketsByEmail()" class="filter-button">Filtrar</button>
            </div>

            <ul id="filteredTicketsList" class="tickets-list"></ul>
        </div>
    </section>

    <footer class="footer">
        <p>&copy; 2025 SoporteTech. Todos los derechos reservados.</p>
        <p><a href="#">PolÃ­tica de Privacidad</a> | <a href="#">TÃ©rminos de Servicio</a></p>
    </footer>
     <script src="firebase-app.js"></script>
<script>
// ğŸ”¥ CARGAR DIRECTAMENTE DESDE FIREBASE
let allTickets = [];

// ğŸ”¥ ESPERAR A QUE FIREBASE ESTÃ‰ COMPLETAMENTE LISTO
async function waitForFirebase() {
    console.log('â³ Esperando Firebase...');
    console.log('ğŸ” Estado actual:', {
        'firebaseApp existe': !!window.firebaseApp,
        'firebaseApp.initialized': window.firebaseApp?.initialized,
        'Firebase SDK': typeof firebase
    });
    
    // Si ya estÃ¡ listo, genial
    if (window.firebaseApp && window.firebaseApp.initialized) {
        console.log('âœ… Firebase ya estÃ¡ listo');
        return true;
    }
    
    // Esperar a que firebase-app.js termine de ejecutarse
    let firebaseLoaded = false;
    for (let i = 0; i < 50; i++) {
        if (window.firebaseApp && window.firebaseApp.initialized) {
            firebaseLoaded = true;
            break;
        }
        
        // Verificar si los scripts de Firebase se estÃ¡n cargando
        const firebaseScripts = Array.from(document.scripts);
        const isFirebaseLoading = firebaseScripts.some(script => 
            script.src.includes('firebase') && !script.onload
        );
        
        if (!isFirebaseLoading && typeof firebase !== 'undefined') {
            console.log('âœ… Scripts de Firebase cargados, esperando inicializaciÃ³n...');
            break;
        }
        
        await new Promise(resolve => setTimeout(resolve, 200));
    }
    
    // Si despuÃ©s de 10 segundos no estÃ¡ listo, intentar inicializar manualmente
    if (!firebaseLoaded) {
        console.log('ğŸ”„ Firebase no se inicializÃ³ automÃ¡ticamente, intentando manualmente...');
        
        if (typeof firebase !== 'undefined' && !window.firebaseApp) {
            console.log('ğŸ”§ Firebase SDK estÃ¡ cargado pero no inicializado');
            // Esperar un poco mÃ¡s para que firebase-app.js haga su trabajo
            await new Promise(resolve => setTimeout(resolve, 2000));
        }
    }
    
    const finalCheck = window.firebaseApp && window.firebaseApp.initialized;
    console.log('ğŸ Estado final de Firebase:', finalCheck ? 'âœ… LISTO' : 'âŒ FALLÃ“');
    return finalCheck;
}

// Obtener el ID del ticket desde la URL
function getTicketIdFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('ticket');
}

// ğŸ”¥ CARGAR TICKET ESPECÃFICO DESDE FIREBASE
async function loadSpecificTicket() {
    const ticketId = getTicketIdFromURL();
    
    if (ticketId) {
        console.log('ğŸ¯ Cargando ticket especÃ­fico:', ticketId);
        
        // OCULTAR filtro de email
        document.getElementById('emailFilterBox').style.display = 'none';
        document.getElementById('introText').style.display = 'none';
        document.getElementById('pageTitle').textContent = 'ğŸ“‹ Detalles del Ticket';
        
        // Cargar ticket directamente desde Firebase
        const ticket = await loadTicketFromFirebase(ticketId);
        
        if (ticket) {
            renderSpecificTicket(ticket);
        } else {
            document.getElementById('filteredTicketsList').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ”</div>
                    <h3>Ticket no encontrado</h3>
                    <p>El ticket #${ticketId} no existe en la base de datos</p>
                    <a href="seguimiento.html" class="btn-toggle">Ver todos los tickets</a>
                </div>
            `;
        }
    } else {
        // Modo normal (filtro por email)
        console.log('ğŸ“§ Modo normal: filtro por email');
        await loadAllTicketsFromFirebase();
    }
}

// ğŸ”¥ CARGAR TICKET ESPECÃFICO DESDE FIREBASE
async function loadTicketFromFirebase(ticketId) {
    console.log('ğŸ”¥ Buscando ticket en Firebase:', ticketId);
    
    if (!window.firebaseApp || !window.firebaseApp.initialized) {
        console.log('âŒ Firebase no estÃ¡ disponible');
        return null;
    }
    
    try {
        // Cargar directamente desde Firestore
        const doc = await window.firebaseApp.db.collection('tickets').doc(ticketId).get();
        
        if (doc.exists) {
            const ticketData = doc.data();
            console.log('âœ… Ticket encontrado en Firebase:', ticketData);
            return {
                id: doc.id,
                ...ticketData,
                comentarios: ticketData.comentarios || [],
                adjuntos: ticketData.adjuntos || []
            };
        } else {
            console.log('âŒ Ticket no existe en Firebase');
            return null;
        }
    } catch (error) {
        console.error('ğŸ’¥ Error cargando ticket de Firebase:', error);
        return null;
    }
}

// ğŸ”¥ CARGAR TODOS LOS TICKETS DESDE FIREBASE
async function loadAllTicketsFromFirebase() {
    console.log('ğŸ”¥ Cargando todos los tickets desde Firebase...');
    
    if (!window.firebaseApp || !window.firebaseApp.initialized) {
        console.log('âŒ Firebase no disponible, mostrando mensaje');
        showFirebaseError();
        return;
    }
    
    try {
        const snapshot = await window.firebaseApp.db.collection('tickets')
            .orderBy('createdAt', 'desc')
            .get();
        
        allTickets = [];
        snapshot.forEach(doc => {
            const data = doc.data();
            allTickets.push({
                id: doc.id,
                ...data,
                comentarios: data.comentarios || [],
                adjuntos: data.adjuntos || []
            });
        });
        
        console.log(`âœ… ${allTickets.length} tickets cargados de Firebase`);
        renderFilteredTickets(''); // Mostrar mensaje de ingreso de email
        
    } catch (error) {
        console.error('ğŸ’¥ Error cargando tickets:', error);
        showFirebaseError();
    }
}

// ğŸ”¥ MOSTRAR ERROR DE FIREBASE
function showFirebaseError() {
    document.getElementById('filteredTicketsList').innerHTML = `
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ”§</div>
            <h3>Base de datos no disponible</h3>
            <p>No se pudieron cargar los tickets. Intenta recargar la pÃ¡gina.</p>
            <button onclick="location.reload()" class="btn-toggle">ğŸ”„ Recargar</button>
        </div>
    `;
}

// ğŸ”¥ RENDERIZAR TICKET ESPECÃFICO
function renderSpecificTicket(ticket) {
    const ticketsList = document.getElementById('filteredTicketsList');
    
    console.log('ğŸ¨ Renderizando ticket:', ticket);
    
    const commentsHtml = ticket.comentarios ? ticket.comentarios.map(comentario => `
        <div class="comment-item ${getCommentClassForUser(comentario, ticket)}">
            <div class="comment-header">
                <strong>${getCommentIconForUser(comentario)} ${comentario.autor}</strong>
                <span class="comment-time">${comentario.fecha}</span>
            </div>
            <div class="comment-text">${comentario.texto}</div>
        </div>
    `).join('') : '<div class="no-comments">No hay comentarios aÃºn.</div>';

    ticketsList.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
            <a href="seguimiento.html" class="btn-toggle">â† Volver a todos los tickets</a>
        </div>
        
        <li class="ticket-item" style="border-left: 5px solid #0066cc;">
            <div class="ticket-header">
                <div class="ticket-title">Ticket #${ticket.id} - ${ticket.asunto}</div>
                <div class="ticket-status ${ticket.estado.toLowerCase()}">${ticket.estado}</div>
            </div>
            <div class="ticket-meta">
                ğŸ‘¤ <strong>${ticket.nombre}</strong> | ğŸ“§ ${ticket.email} | ğŸ“… ${ticket.fecha}
                <span class="ticket-assignee">ğŸ› ï¸ Asignado: ${ticket.tecnico || 'Sin Asignar'}</span>
            </div>
            
            <div class="ticket-description">
                <h4>ğŸ“ DescripciÃ³n del Problema:</h4>
                <p>${ticket.mensaje}</p>
            </div>

            <!-- ğŸ”¥ HISTORIAL DE CHAT COMPLETO -->
            <div class="chat-section">
                <h4>ğŸ’¬ Historial de ConversaciÃ³n (${ticket.comentarios ? ticket.comentarios.length : 0} mensajes)</h4>
                <div class="chat-container" id="chat-${ticket.id}">
                    ${commentsHtml}
                </div>
                
                <!-- FORMULARIO PARA AGREGAR COMENTARIOS -->
                <div class="chat-input-section">
                    <h5>âœï¸ Agregar comentario:</h5>
                    <form class="comment-form" onsubmit="addCommentToTicket(event, '${ticket.id}')">
                        <textarea 
                            placeholder="Escribe tu comentario o pregunta para el equipo de soporte..." 
                            rows="3"
                            required
                            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px;"
                        ></textarea>
                        <div class="form-actions">
                            <button type="submit" class="btn-comment">ğŸ“¨ Enviar Comentario</button>
                            <button type="button" class="btn-toggle" onclick="toggleEstado('${ticket.id}')">
                                ${ticket.estado === 'Abierto' ? 'ğŸ”’ Cerrar Ticket' : 'ğŸ”“ Reabrir Ticket'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </li>
    `;
    
    // Auto-scroll al final del chat
    setTimeout(() => {
        const chatContainer = document.getElementById(`chat-${ticket.id}`);
        if (chatContainer) {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    }, 100);
}

// ğŸ”¥ FUNCIONES AUXILIARES (mantener las mismas)
function getCommentClassForUser(comentario, ticket) {
    if (comentario.autor === ticket.nombre) return 'comment-user';
    if (comentario.autor === 'Sistema') return 'comment-system';
    return 'comment-support';
}

function getCommentIconForUser(comentario) {
    if (comentario.autor === 'Sistema') return 'âš™ï¸';
    if (comentario.tipo === 'tecnico' || comentario.tipo === 'interno') return 'ğŸ› ï¸';
    return 'ğŸ‘¤';
}

// ğŸ”¥ AGREGAR COMENTARIO DIRECTAMENTE A FIREBASE
async function addCommentToTicket(e, ticketId) {
    e.preventDefault();
    
    const form = e.target;
    const textarea = form.querySelector('textarea');
    const commentText = textarea.value.trim();
    
    if (!commentText) {
        alert('Por favor, escribe un comentario antes de enviar.');
        return;
    }
    
    if (!window.firebaseApp || !window.firebaseApp.initialized) {
        alert('Error: Base de datos no disponible');
        return;
    }
    
    // Cargar ticket actual para obtener informaciÃ³n del usuario
    const ticket = await loadTicketFromFirebase(ticketId);
    if (!ticket) {
        alert('Error: Ticket no encontrado');
        return;
    }
    
    const comment = {
        autor: ticket.nombre,
        texto: commentText,
        fecha: new Date().toLocaleString('es-ES'),
        tipo: 'usuario',
        email: ticket.email
    };
    
    try {
        // Agregar comentario al ticket en Firebase
        const ticketRef = window.firebaseApp.db.collection('tickets').doc(ticketId);
        await ticketRef.update({
            comentarios: [...(ticket.comentarios || []), comment],
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('âœ… Comentario agregado a Firebase');
        textarea.value = '';
        
        // Recargar el ticket para mostrar el nuevo comentario
        loadSpecificTicket();
        
    } catch (error) {
        console.error('âŒ Error agregando comentario:', error);
        alert('Error al enviar el comentario');
    }
}

// ğŸ”¥ TOGGLE ESTADO EN FIREBASE
async function toggleEstado(ticketId) {
    if (!window.firebaseApp || !window.firebaseApp.initialized) {
        alert('Error: Base de datos no disponible');
        return;
    }
    
    try {
        const ticket = await loadTicketFromFirebase(ticketId);
        if (!ticket) {
            alert('Error: Ticket no encontrado');
            return;
        }
        
        const nuevoEstado = ticket.estado === 'Abierto' ? 'Cerrado' : 'Abierto';
        const nuevoComentario = {
            autor: 'Sistema',
            texto: `Estado cambiado a ${nuevoEstado}.`,
            fecha: new Date().toLocaleString('es-ES'),
            tipo: 'sistema'
        };
        
        const ticketRef = window.firebaseApp.db.collection('tickets').doc(ticketId);
        await ticketRef.update({
            estado: nuevoEstado,
            comentarios: [...(ticket.comentarios || []), nuevoComentario],
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('âœ… Estado actualizado en Firebase');
        
        // Recargar el ticket
        loadSpecificTicket();
        
    } catch (error) {
        console.error('âŒ Error actualizando estado:', error);
        alert('Error al cambiar el estado del ticket');
    }
}

// ğŸ”¥ MODO NORMAL (filtro por email)
function filterTicketsByEmail() {
    const email = document.getElementById('filterEmail').value.trim();
    renderFilteredTickets(email);
}

function renderFilteredTickets(emailToFilter) {
    const ticketsList = document.getElementById('filteredTicketsList');
    ticketsList.innerHTML = '';
    
    const filteredTickets = emailToFilter 
        ? allTickets.filter(t => t.email.toLowerCase() === emailToFilter.toLowerCase())
        : [];
        
    if (filteredTickets.length === 0 && emailToFilter) {
        ticketsList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ§</div>
                <h3>No se encontraron tickets</h3>
                <p>Verifica el correo electrÃ³nico ingresado</p>
            </div>
        `;
        return;
    } else if (!emailToFilter) {
        ticketsList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“§</div>
                <h3>Ingresa tu correo</h3>
                <p>Para ver el historial de tus tickets, ingresa tu direcciÃ³n de correo electrÃ³nico</p>
            </div>
        `;
        return;
    }

    filteredTickets.reverse().forEach(ticket => {
        const li = document.createElement('li');
        li.className = 'ticket-item';
        
        li.innerHTML = `
            <div class="ticket-header">
                <div class="ticket-title">Ticket #${ticket.id} - ${ticket.asunto}</div>
                <div class="ticket-status ${ticket.estado.toLowerCase()}">${ticket.estado}</div>
            </div>
            <div class="ticket-meta">
                ğŸ‘¤ ${ticket.nombre} | ğŸ“… ${ticket.fecha}
                <span class="ticket-assignee">ğŸ› ï¸ Asignado: ${ticket.tecnico}</span>
            </div>
            <div class="ticket-message">${ticket.mensaje.substring(0, 100)}${ticket.mensaje.length > 100 ? '...' : ''}</div>
            <div class="ticket-actions">
                <a href="seguimiento.html?ticket=${ticket.id}" class="btn-toggle">Ver Detalles Completos</a>
                <button class="btn-toggle" onclick="toggleEstado('${ticket.id}')">
                    Marcar como ${ticket.estado === 'Abierto' ? 'Cerrado' : 'Abierto'}
                </button>
            </div>
        `;
        ticketsList.appendChild(li);
    });
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ Iniciando seguimiento.html');
    
    // Esperar 1 segundo antes de empezar para dar tiempo a Firebase
    setTimeout(async () => {
        console.log('ğŸ• Iniciando despuÃ©s de delay...');
        await loadSpecificTicket();
    }, 1000);
});
</script>
</body>
</html>