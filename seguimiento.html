<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Seguimiento de Tickets | SoporteTech</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="seguimiento.css" />
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo">üõ†Ô∏è SoporteTech</div>
            <nav>
                <ul class="nav">
                    <li><a href="index.html#inicio">Inicio</a></li>
                    <li><a href="index.html#servicios">Servicios</a></li>
                    <li><a href="index.html#crear-ticket">Crear Ticket</a></li>
                    <li><a href="index.html#mis-tickets">Mis Tickets</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="tracking-section">
        <div class="container">
            <h2 class="section-title" id="pageTitle">üìã Seguimiento de Mis Tickets</h2>
            <p class="intro-text" id="introText">
                Aqu√≠ puedes ver el estado de todos los tickets que has enviado. Usa la funcionalidad de comentarios para a√±adir m√°s detalles.
            </p>

            <div class="email-filter-box" id="emailFilterBox">
                <label for="filterEmail">Mostrar tickets para el correo:</label>
                <input type="email" id="filterEmail" placeholder="Ingresa tu correo para filtrar" class="email-input">
                <button onclick="filterTicketsByEmail()" class="filter-button">Filtrar</button>
            </div>

            <ul id="filteredTicketsList" class="tickets-list"></ul>
        </div>
    </section>

    <footer class="footer">
        <p>&copy; 2025 SoporteTech. Todos los derechos reservados.</p>
        <p><a href="#">Pol√≠tica de Privacidad</a> | <a href="#">T√©rminos de Servicio</a></p>
    </footer>
     <script src="firebase-app.js"></script>
<script>
// üî• CARGAR DIRECTAMENTE DESDE FIREBASE
let allTickets = [];

// üî• ESPERAR A QUE FIREBASE EST√â COMPLETAMENTE LISTO
async function waitForFirebase() {
    console.log('‚è≥ Esperando Firebase...');
    console.log('üîç Estado actual:', {
        'firebaseApp existe': !!window.firebaseApp,
        'firebaseApp.initialized': window.firebaseApp?.initialized,
        'Firebase SDK': typeof firebase
    });
    
    // Si ya est√° listo, genial
    if (window.firebaseApp && window.firebaseApp.initialized) {
        console.log('‚úÖ Firebase ya est√° listo');
        return true;
    }
    
    // Esperar a que firebase-app.js termine de ejecutarse
    let firebaseLoaded = false;
    for (let i = 0; i < 50; i++) {
        if (window.firebaseApp && window.firebaseApp.initialized) {
            firebaseLoaded = true;
            break;
        }
        
        // Verificar si los scripts de Firebase se est√°n cargando
        const firebaseScripts = Array.from(document.scripts);
        const isFirebaseLoading = firebaseScripts.some(script => 
            script.src.includes('firebase') && !script.onload
        );
        
        if (!isFirebaseLoading && typeof firebase !== 'undefined') {
            console.log('‚úÖ Scripts de Firebase cargados, esperando inicializaci√≥n...');
            break;
        }
        
        await new Promise(resolve => setTimeout(resolve, 200));
    }
    
    // Si despu√©s de 10 segundos no est√° listo, intentar inicializar manualmente
    if (!firebaseLoaded) {
        console.log('üîÑ Firebase no se inicializ√≥ autom√°ticamente, intentando manualmente...');
        
        if (typeof firebase !== 'undefined' && !window.firebaseApp) {
            console.log('üîß Firebase SDK est√° cargado pero no inicializado');
            // Esperar un poco m√°s para que firebase-app.js haga su trabajo
            await new Promise(resolve => setTimeout(resolve, 2000));
        }
    }
    
    const finalCheck = window.firebaseApp && window.firebaseApp.initialized;
    console.log('üèÅ Estado final de Firebase:', finalCheck ? '‚úÖ LISTO' : '‚ùå FALL√ì');
    return finalCheck;
}

// Obtener el ID del ticket desde la URL
function getTicketIdFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('ticket');
}

// üî• CARGAR TICKET ESPEC√çFICO DESDE FIREBASE
async function loadSpecificTicket() {
    const ticketId = getTicketIdFromURL();
    
    if (ticketId) {
        console.log('üéØ Cargando ticket espec√≠fico:', ticketId);
        
        // OCULTAR filtro de email
        document.getElementById('emailFilterBox').style.display = 'none';
        document.getElementById('introText').style.display = 'none';
        document.getElementById('pageTitle').textContent = 'üìã Detalles del Ticket';
        
        // Cargar ticket directamente desde Firebase
        const ticket = await loadTicketFromFirebase(ticketId);
        
        if (ticket) {
            renderSpecificTicket(ticket);
        } else {
            document.getElementById('filteredTicketsList').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üîç</div>
                    <h3>Ticket no encontrado</h3>
                    <p>El ticket #${ticketId} no existe en la base de datos</p>
                    <a href="seguimiento.html" class="btn-toggle">Ver todos los tickets</a>
                </div>
            `;
        }
    } else {
        // Modo normal (filtro por email)
        console.log('üìß Modo normal: filtro por email');
        await loadAllTicketsFromFirebase();
    }
}

// üî• CARGAR TICKET ESPEC√çFICO DESDE FIREBASE
async function loadTicketFromFirebase(ticketId) {
    console.log('üî• Buscando ticket en Firebase:', ticketId);
    
    if (!window.firebaseApp || !window.firebaseApp.initialized) {
        console.log('‚ùå Firebase no est√° disponible');
        return null;
    }
    
    try {
        // Cargar directamente desde Firestore
        const doc = await window.firebaseApp.db.collection('tickets').doc(ticketId).get();
        
        if (doc.exists) {
            const ticketData = doc.data();
            console.log('‚úÖ Ticket encontrado en Firebase:', ticketData);
            return {
                id: doc.id,
                ...ticketData,
                comentarios: ticketData.comentarios || [],
                adjuntos: ticketData.adjuntos || []
            };
        } else {
            console.log('‚ùå Ticket no existe en Firebase');
            return null;
        }
    } catch (error) {
        console.error('üí• Error cargando ticket de Firebase:', error);
        return null;
    }
}

// üî• CARGAR TODOS LOS TICKETS DESDE FIREBASE
async function loadAllTicketsFromFirebase() {
    console.log('üî• Cargando todos los tickets desde Firebase...');
    
    if (!window.firebaseApp || !window.firebaseApp.initialized) {
        console.log('‚ùå Firebase no disponible, mostrando mensaje');
        showFirebaseError();
        return;
    }
    
    try {
        const snapshot = await window.firebaseApp.db.collection('tickets')
            .orderBy('createdAt', 'desc')
            .get();
        
        allTickets = [];
        snapshot.forEach(doc => {
            const data = doc.data();
            allTickets.push({
                id: doc.id,
                ...data,
                comentarios: data.comentarios || [],
                adjuntos: data.adjuntos || []
            });
        });
        
        console.log(`‚úÖ ${allTickets.length} tickets cargados de Firebase`);
        renderFilteredTickets(''); // Mostrar mensaje de ingreso de email
        
    } catch (error) {
        console.error('üí• Error cargando tickets:', error);
        showFirebaseError();
    }
}

// üî• MOSTRAR ERROR DE FIREBASE
function showFirebaseError() {
    document.getElementById('filteredTicketsList').innerHTML = `
        <div class="empty-state">
            <div class="empty-state-icon">üîß</div>
            <h3>Base de datos no disponible</h3>
            <p>No se pudieron cargar los tickets. Intenta recargar la p√°gina.</p>
            <button onclick="location.reload()" class="btn-toggle">üîÑ Recargar</button>
        </div>
    `;
}

// üî• RENDERIZAR TICKET ESPEC√çFICO
function renderSpecificTicket(ticket) {
    const ticketsList = document.getElementById('filteredTicketsList');
    
    console.log('üé® Renderizando ticket:', ticket);
    

const commentsHtml = ticket.comentarios ? ticket.comentarios.map(comentario => `
    <div class="comment-item ${getCommentClassForUser(comentario, ticket)}">
        <div class="comment-header">
            <strong>${getCommentIconForUser(comentario)} ${comentario.autor}</strong>
            <span class="comment-time">${comentario.fecha}</span>
        </div>
        <div class="comment-text">${comentario.texto}</div>
        
        <!-- üî• MOSTRAR ARCHIVO ADJUNTO SI EXISTE -->
       // En renderSpecificTicket() - ACTUALIZAR visualizaci√≥n de archivos
${comentario.archivo ? `
    <div class="attached-file">
        <strong>üìé Archivo adjunto:</strong>
        ${comentario.archivo.tipo.startsWith('image/') ? `
            <div class="attached-image">
                <img src="${comentario.archivo.data}" alt="${comentario.archivo.nombre}" 
                     style="max-width: 200px; max-height: 150px; border-radius: 4px; margin-top: 5px; cursor: pointer;"
                     onclick="openImageModal('${comentario.archivo.data}')">
                <div class="file-info-small">
                    ${comentario.archivo.nombre} (${formatFileSize(comentario.archivo.tama√±o)})
                </div>
            </div>
        ` : `
            <div class="attached-document">
                <div class="file-info">
                    <span class="file-name">üìÑ ${comentario.archivo.nombre}</span>
                    <span class="file-size">${formatFileSize(comentario.archivo.tama√±o)}</span>
                </div>
                <small><em>Archivo guardado en la base de datos</em></small>
            </div>
        `}
    </div>
` : ''}
    </div>
`).join('') : '<div class="no-comments">No hay comentarios a√∫n.</div>';
    ticketsList.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
            <a href="seguimiento.html" class="btn-toggle">‚Üê Volver a todos los tickets</a>
        </div>
        
        <li class="ticket-item" style="border-left: 5px solid #0066cc;">
            <div class="ticket-header">
                <div class="ticket-title">Ticket #${ticket.id} - ${ticket.asunto}</div>
                <div class="ticket-status ${ticket.estado.toLowerCase()}">${ticket.estado}</div>
            </div>
            <div class="ticket-meta">
                üë§ <strong>${ticket.nombre}</strong> | üìß ${ticket.email} | üìÖ ${ticket.fecha}
                <span class="ticket-assignee">üõ†Ô∏è Asignado: ${ticket.tecnico || 'Sin Asignar'}</span>
            </div>
            
            <div class="ticket-description">
                <h4>üìù Descripci√≥n del Problema:</h4>
                <p>${ticket.mensaje}</p>
            </div>

            <!-- üî• HISTORIAL DE CHAT COMPLETO -->
            <div class="chat-section">
                <h4>üí¨ Historial de Conversaci√≥n (${ticket.comentarios ? ticket.comentarios.length : 0} mensajes)</h4>
                <div class="chat-container" id="chat-${ticket.id}">
                    ${commentsHtml}
                </div>
                
                <!-- FORMULARIO PARA AGREGAR COMENTARIOS -->
<div class="chat-input-section">
    <h5>‚úçÔ∏è Agregar comentario:</h5>
    <form class="comment-form" onsubmit="addCommentToTicket(event, '${ticket.id}')" enctype="multipart/form-data">
        <textarea 
            placeholder="Escribe tu comentario o pregunta para el equipo de soporte..." 
            rows="3"
            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px;"
            id="textarea-${ticket.id}"
        ></textarea>
        
        <!-- üî• NUEVO: INPUT PARA IM√ÅGENES -->
        <div class="file-input-section">
            <label for="file-${ticket.id}" class="file-label">
                üìé Adjuntar imagen
            </label>
            <input 
                type="file" 
                id="file-${ticket.id}" 
                accept="image/*,.pdf,.doc,.docx"
                class="file-input"
                onchange="previewImage('${ticket.id}')"
            >
            <div id="preview-${ticket.id}" class="image-preview"></div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn-comment">üì® Enviar Comentario</button>
            <button type="button" class="btn-toggle" onclick="toggleEstado('${ticket.id}')">
                ${ticket.estado === 'Abierto' ? 'üîí Cerrar Ticket' : 'üîì Reabrir Ticket'}
            </button>
        </div>
    </form>
</div>
                        </div>
                    </form>
                </div>
            </div>
        </li>
    `;
    
    // Auto-scroll al final del chat
    setTimeout(() => {
        const chatContainer = document.getElementById(`chat-${ticket.id}`);
        if (chatContainer) {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    }, 100);
}

// üî• FUNCIONES AUXILIARES (mantener las mismas)
function getCommentClassForUser(comentario, ticket) {
    if (comentario.autor === ticket.nombre) return 'comment-user';
    if (comentario.autor === 'Sistema') return 'comment-system';
    return 'comment-support';
}

function getCommentIconForUser(comentario) {
    if (comentario.autor === 'Sistema') return '‚öôÔ∏è';
    if (comentario.tipo === 'tecnico' || comentario.tipo === 'interno') return 'üõ†Ô∏è';
    return 'üë§';
}



// üî• TOGGLE ESTADO EN FIREBASE
async function toggleEstado(ticketId) {
    if (!window.firebaseApp || !window.firebaseApp.initialized) {
        alert('Error: Base de datos no disponible');
        return;
    }
    
    try {
        const ticket = await loadTicketFromFirebase(ticketId);
        if (!ticket) {
            alert('Error: Ticket no encontrado');
            return;
        }
        
        const nuevoEstado = ticket.estado === 'Abierto' ? 'Cerrado' : 'Abierto';
        const nuevoComentario = {
            autor: 'Sistema',
            texto: `Estado cambiado a ${nuevoEstado}.`,
            fecha: new Date().toLocaleString('es-ES'),
            tipo: 'sistema'
        };
        
        const ticketRef = window.firebaseApp.db.collection('tickets').doc(ticketId);
        await ticketRef.update({
            estado: nuevoEstado,
            comentarios: [...(ticket.comentarios || []), nuevoComentario],
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('‚úÖ Estado actualizado en Firebase');
        
        // Recargar el ticket
        loadSpecificTicket();
        
    } catch (error) {
        console.error('‚ùå Error actualizando estado:', error);
        alert('Error al cambiar el estado del ticket');
    }
}

// üî• MODO NORMAL (filtro por email)
function filterTicketsByEmail() {
    const email = document.getElementById('filterEmail').value.trim();
    renderFilteredTickets(email);
}

function renderFilteredTickets(emailToFilter) {
    const ticketsList = document.getElementById('filteredTicketsList');
    ticketsList.innerHTML = '';
    
    const filteredTickets = emailToFilter 
        ? allTickets.filter(t => t.email.toLowerCase() === emailToFilter.toLowerCase())
        : [];
        
    if (filteredTickets.length === 0 && emailToFilter) {
        ticketsList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üßê</div>
                <h3>No se encontraron tickets</h3>
                <p>Verifica el correo electr√≥nico ingresado</p>
            </div>
        `;
        return;
    } else if (!emailToFilter) {
        ticketsList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìß</div>
                <h3>Ingresa tu correo</h3>
                <p>Para ver el historial de tus tickets, ingresa tu direcci√≥n de correo electr√≥nico</p>
            </div>
        `;
        return;
    }

    filteredTickets.reverse().forEach(ticket => {
        const li = document.createElement('li');
        li.className = 'ticket-item';
        
        li.innerHTML = `
            <div class="ticket-header">
                <div class="ticket-title">Ticket #${ticket.id} - ${ticket.asunto}</div>
                <div class="ticket-status ${ticket.estado.toLowerCase()}">${ticket.estado}</div>
            </div>
            <div class="ticket-meta">
                üë§ ${ticket.nombre} | üìÖ ${ticket.fecha}
                <span class="ticket-assignee">üõ†Ô∏è Asignado: ${ticket.tecnico}</span>
            </div>
            <div class="ticket-message">${ticket.mensaje.substring(0, 100)}${ticket.mensaje.length > 100 ? '...' : ''}</div>
            <div class="ticket-actions">
                <a href="seguimiento.html?ticket=${ticket.id}" class="btn-toggle">Ver Detalles Completos</a>
                <button class="btn-toggle" onclick="toggleEstado('${ticket.id}')">
                    Marcar como ${ticket.estado === 'Abierto' ? 'Cerrado' : 'Abierto'}
                </button>
            </div>
        `;
        ticketsList.appendChild(li);
    });
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Iniciando seguimiento.html');
    
    // Esperar 1 segundo antes de empezar para dar tiempo a Firebase
    setTimeout(async () => {
        console.log('üïê Iniciando despu√©s de delay...');
        await loadSpecificTicket();
    }, 1000);
});
// üî• FUNCI√ìN PARA PREVIEW DE IM√ÅGENES
function previewImage(ticketId) {
    const fileInput = document.getElementById(`file-${ticketId}`);
    const previewContainer = document.getElementById(`preview-${ticketId}`);
    const file = fileInput.files[0];
    
    if (!file) {
        previewContainer.style.display = 'none';
        previewContainer.innerHTML = '';
        return;
    }
    
    // Validar tipo de archivo
    const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'application/pdf'];
    if (!validTypes.includes(file.type)) {
        alert('Solo se permiten im√°genes (JPEG, PNG, GIF, WebP) y PDF');
        fileInput.value = '';
        return;
    }
    
    // Validar tama√±o (m√°ximo 5MB)
    const maxSize = 5 * 1024 * 1024; // 5MB
    if (file.size > maxSize) {
        alert('El archivo es demasiado grande. M√°ximo 5MB');
        fileInput.value = '';
        return;
    }
    
    previewContainer.style.display = 'block';
    
    if (file.type.startsWith('image/')) {
        // Es una imagen - mostrar preview
        const reader = new FileReader();
        reader.onload = function(e) {
            previewContainer.innerHTML = `
                <div class="preview-item">
                    <img src="${e.target.result}" class="preview-image" alt="Preview">
                    <button type="button" class="remove-preview" onclick="removePreview('${ticketId}')">√ó</button>
                </div>
                <div class="file-info">
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${formatFileSize(file.size)}</span>
                </div>
            `;
        };
        reader.readAsDataURL(file);
    } else {
        // Es un PDF u otro archivo - solo mostrar info
        previewContainer.innerHTML = `
            <div class="file-info">
                <span class="file-name">${file.name}</span>
                <span class="file-size">${formatFileSize(file.size)}</span>
                <button type="button" class="btn-toggle" onclick="removePreview('${ticketId}')" style="margin-left: 10px; padding: 2px 8px; font-size: 0.8em;">
                    Quitar
                </button>
            </div>
        `;
    }
}

// üî• FORMATEAR TAMA√ëO DE ARCHIVO
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// üî• REMOVER PREVIEW
function removePreview(ticketId) {
    const fileInput = document.getElementById(`file-${ticketId}`);
    const previewContainer = document.getElementById(`preview-${ticketId}`);
    
    fileInput.value = '';
    previewContainer.style.display = 'none';
    previewContainer.innerHTML = '';
}

// üî• FUNCI√ìN MEJORADA PARA AGREGAR COMENTARIOS CON IM√ÅGENES
// üî• FUNCI√ìN MEJORADA - USAR DATA URLs REALES
async function addCommentToTicket(e, ticketId) {
    e.preventDefault();
    
    const form = e.target;
    const textarea = document.getElementById(`textarea-${ticketId}`);
    const fileInput = document.getElementById(`file-${ticketId}`);
    const commentText = textarea.value.trim();
    const file = fileInput.files[0];
    
    if (!commentText && !file) {
        alert('Por favor, escribe un comentario o adjunta una imagen');
        return;
    }
    
    if (!window.firebaseApp || !window.firebaseApp.initialized) {
        alert('Error: Base de datos no disponible');
        return;
    }
    
    // Cargar ticket actual
    const ticket = await loadTicketFromFirebase(ticketId);
    if (!ticket) {
        alert('Error: Ticket no encontrado');
        return;
    }
    
    try {
        let fileData = null;
        
        // Si hay archivo, convertirlo a Data URL
        if (file) {
            console.log('üì§ Procesando archivo:', file.name);
            
            try {
                fileData = await convertFileToDataURL(file);
                console.log('‚úÖ Archivo convertido a Data URL');
            } catch (error) {
                console.error('‚ùå Error convirtiendo archivo:', error);
                alert('Error al procesar el archivo');
                return;
            }
        }
        
        const comment = {
            autor: ticket.nombre,
            texto: commentText || '(archivo adjunto)', // Si no hay texto, poner mensaje por defecto
            fecha: new Date().toLocaleString('es-ES'),
            tipo: 'usuario',
            email: ticket.email,
            archivo: file ? {
                nombre: file.name,
                data: fileData, // üî• DATA URL REAL
                tipo: file.type,
                tama√±o: file.size,
                esDataURL: true
            } : null
        };
        
        // Agregar comentario al ticket en Firebase
        const ticketRef = window.firebaseApp.db.collection('tickets').doc(ticketId);
        await ticketRef.update({
            comentarios: [...(ticket.comentarios || []), comment],
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('‚úÖ Comentario con archivo agregado a Firebase');
        
        // Limpiar formulario
        textarea.value = '';
        removePreview(ticketId);
        
        // Recargar el ticket
        loadSpecificTicket();
        
    } catch (error) {
        console.error('‚ùå Error agregando comentario con archivo:', error);
        alert('Error al enviar el comentario');
    }
}
// üî• MODAL PARA VER IM√ÅGENES EN GRANDE
function openImageModal(imageUrl) {
    const modalHtml = `
        <div id="imageModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 10000;">
            <div style="position: relative;">
                <img src="${imageUrl}" style="max-width: 90vw; max-height: 90vh; border-radius: 8px;">
                <button onclick="closeImageModal()" style="position: absolute; top: -40px; right: 0; background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 16px; cursor: pointer;">√ó</button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeImageModal() {
    const modal = document.getElementById('imageModal');
    if (modal) {
        modal.remove();
    }
}

// Cerrar modal con ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeImageModal();
    }
});
// üî• CONVERTIR ARCHIVO A DATA URL (base64)
function convertFileToDataURL(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            resolve(e.target.result); // Esto devuelve la Data URL
        };
        reader.onerror = function(error) {
            reject(error);
        };
        reader.readAsDataURL(file);
    });
}
</script>
</body>
</html>